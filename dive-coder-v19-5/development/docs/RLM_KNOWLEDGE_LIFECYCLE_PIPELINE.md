# RLM + Knowledge lifecycle pipeline (IKO / EvidencePack / Gatekeeper)

This repo ships a **base skill**: **vibe- RLM + Knowledge lifecycle**.
It is not just “RLM querying”; it also defines a **production workflow** for how issues move through verification.

## Core roles

- **IKO (Issue Knowledge Object)**: *single source of truth* for one issue.
  - Stored at: `.vibe/iko/<IKO_ID>.json`
  - Holds state, links, evidencepack pointers, investigations, audit trail.

- **EvidencePack**: auto-collected evidence bundle from CI/CD and/or Canary.
  - Stored at: `.vibe/evidence/<EVIDENCEPACK_ID>.evidencepack.json`
  - Contains pointers + checksums for reports (vibe-report, SARIF, gates, canary metrics…).

- **Gatekeeper**: the **only** component allowed to change IKO state.
  - Gatekeeper enforces state transitions + evidencepack requirements.

- **RLM**: “investigate + verify” only.
  - RLM attaches investigations to IKOs.
  - RLM does **NOT** decide “done”; it outputs evidence + recommendation.

## Recommended state machine

`NEW → INVESTIGATING → EVIDENCE_READY → APPROVED → DEPLOYING → DEPLOYED → CLOSED`

`REJECTED` is allowed from `INVESTIGATING`, `EVIDENCE_READY`, `DEPLOYING`.

Gatekeeper transition rules live in: `.shared/vibe-coder-v13/gatekeeper/state.py`.

## Folder layout

- `.vibe/iko/` — IKO JSON files (SSoT)
- `.vibe/iko/investigations/` — RLM investigation outputs (attached to IKOs)
- `.vibe/evidence/` — EvidencePacks generated by CI/CD/Canary
- `.vibe/reports/` — Vibe review outputs (vibe-report.json, SARIF, md)
- `.vibe/gates/` — gate results (json)

## CLI (local + CI)

### 1) Create an IKO

```bash
python3 .shared/vibe-coder-v13/vibe.py iko-new --repo . --id IKO-123 --title "Fix n8n idempotency" --description "Webhook triggers duplicate runs" --actor adrian
```

### 2) RLM investigate (query-first)

```bash
# Build index once if needed
python3 .shared/vibe-coder-v13/vibe.py index-build --repo .

# Investigation attaches to IKO, but does NOT change state
python3 .shared/vibe-coder-v13/vibe.py investigate --repo . --issue-id IKO-123 --question "Where can duplicate webhook runs happen?" --limit 25
```

### 3) Generate EvidencePack (CI/CD or Canary)

```bash
# Run review first
python3 .shared/vibe-coder-v13/vibe.py review --repo . --mode accuracy --run-gates \
  --out .vibe/reports/vibe-report.json --md-out .vibe/reports/vibe-report.md --sarif-out .vibe/reports/vibe.sarif.json

# Collect evidence bundle
python3 .shared/vibe-coder-v13/vibe.py evidencepack --repo . --issue-id IKO-123 --outdir .vibe/evidence --ci-run-id local
```

### 4) Gatekeeper transition (ONLY place allowed to change state)

```bash
python3 .shared/vibe-coder-v13/vibe.py gatekeeper --repo . --issue-id IKO-123 \
  --to EVIDENCE_READY --actor gatekeeper --reason "CI passed; evidence attached" \
  --evidencepack .vibe/evidence/ep-IKO-123-<pid>.evidencepack.json
```

## CI/CD integration

A template workflow is provided at:
- `.github/workflows/vibe-evidencepack.yml`

It demonstrates:
- run `vibe review` + `vibe sarif`
- collect EvidencePack
- upload artifacts

